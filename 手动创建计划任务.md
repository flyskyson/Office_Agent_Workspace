# 手动创建工作区维护计划任务

如果自动设置脚本失败，可以按照以下步骤手动创建计划任务。

---

## 方法一：使用任务计划程序（图形界面）

### 步骤：

1. **打开任务计划程序**
   - 按 `Win + R`
   - 输入 `taskschd.msc`
   - 按回车

2. **创建基本任务**
   - 点击右侧 "创建基本任务"
   - 名称：`Office_Workspace_Weekly_Maintenance`
   - 描述：`Office Agent Workspace 自动维护 - 每周运行一次清理和健康检查`
   - 点击 "下一步"

3. **设置触发器**
   - 选择 "每周"
   - 点击 "下一步"
   - 勾选 "星期日"
   - 设置时间：`02:00:00`
   - 点击 "下一步"

4. **设置操作**
   - 选择 "启动程序"
   - 点击 "下一步"
   - 程序或脚本：`python`（或完整路径如 `C:\Python314\python.exe`）
   - 添加参数：`"C:\Users\flyskyson\Office_Agent_Workspace\workspace_maintenance.py" --health-report`
     - **注意**：将路径改为你的实际工作区路径
   - 起始于：`C:\Users\flyskyson\Office_Agent_Workspace`
     - **注意**：将路径改为你的实际工作区路径
   - 点击 "下一步"

5. **完成**
   - 勾选 "当单击完成时，打开此任务属性的对话框"
   - 点击 "完成"

6. **高级设置（可选但推荐）**
   - 在属性对话框中：
     - 切换到 "常规" 标签
     - 选择 "不管用户是否登录都要运行"
     - 勾选 "使用最高权限运行"
     - 勾选 "已禁用"（取消勾选，确保任务启用）
   - 切换到 "条件" 标签
     - 勾选 "只有在计算机使用交流电源时才启动此任务"（如果是笔记本）
     - 勾选 "如果计算机使用电池，则启动任务"（可选）
   - 切换到 "设置" 标签
     - 勾选 "如果任务失败，按以下频率重新启动"
     - 设置为 "5 分钟"
     - 尝试重新启动 "3 次"
   - 点击 "确定"

---

## 方法二：使用 PowerShell 命令（管理员）

1. **以管理员身份打开 PowerShell**
   - 按 `Win + X`
   - 选择 "Windows PowerShell (管理员)" 或 "终端 (管理员)"

2. **运行以下命令**（根据你的实际路径修改）：

```powershell
# 设置变量
$TaskName = "Office_Workspace_Weekly_Maintenance"
$WorkspacePath = "C:\Users\flyskyson\Office_Agent_Workspace"
$PythonPath = "python"  # 或完整路径如 "C:\Python314\python.exe"
$MaintenanceScript = Join-Path $WorkspacePath "workspace_maintenance.py"

# 创建任务动作
$Action = New-ScheduledTaskAction `
    -Execute $PythonPath `
    -Argument "`"$MaintenanceScript`" --health-report" `
    -WorkingDirectory $WorkspacePath

# 创建触发器 - 每周日凌晨 2 点
$Trigger = New-ScheduledTaskTrigger `
    -Weekly `
    -DaysOfWeek Sunday `
    -At 2am

# 创建任务设置
$Settings = New-ScheduledTaskSettingsSet `
    -AllowStartIfOnBatteries `
    -DontStopIfGoingOnBatteries `
    -StartWhenAvailable `
    -RunOnlyIfNetworkAvailable `
    -DontStopOnIdleEnd

# 注册任务
Register-ScheduledTask `
    -TaskName $TaskName `
    -Action $Action `
    -Trigger $Trigger `
    -Settings $Settings `
    -Description "Office Agent Workspace 自动维护" `
    -User "SYSTEM"

Write-Host "任务创建成功!" -ForegroundColor Green
```

---

## 方法三：使用批处理文件（最简单）

我已经为你创建了 `setup_scheduled_maintenance.bat`，只需：

1. **右键点击** `setup_scheduled_maintenance.bat`
2. **选择** "以管理员身份运行"
3. **在 UAC 提示中点击"是"**

---

## 验证任务是否创建成功

### 方法 1：使用检查脚本
双击运行：`check_scheduled_task.bat`

### 方法 2：使用任务计划程序
1. 打开 `taskschd.msc`
2. 在任务计划程序库中查找 `Office_Workspace_Weekly_Maintenance`

### 方法 3：使用 PowerShell
```powershell
Get-ScheduledTask -TaskName "Office_Workspace_Weekly_Maintenance"
```

### 方法 4：立即测试任务
```powershell
# 以管理员身份运行 PowerShell
Start-ScheduledTask -TaskName "Office_Workspace_Weekly_Maintenance"

# 查看运行结果
Get-ScheduledTaskInfo -TaskName "Office_Workspace_Weekly_Maintenance"
```

---

## 常见问题

### Q1: UAC 提示时点击了"否"怎么办？
**A:** 重新运行 `setup_scheduled_maintenance.bat`，这次点击"是"

### Q2: 提示 "找不到 Python"
**A:**
- 确保 Python 已安装
- 确保 Python 已添加到 PATH
- 或者在任务中使用 Python 的完整路径，如 `C:\Python314\python.exe`

### Q3: 任务创建成功但没有运行
**A:**
- 检查任务历史记录（在任务计划程序中）
- 确保计算机在设定时间是开机的
- 尝试手动运行任务测试

### Q4: 想修改运行时间
**A:**
1. 打开 `taskschd.msc`
2. 找到任务，右键 → "属性"
3. 在 "触发器" 标签中编辑时间

### Q5: 想删除任务
**A:**
```powershell
Unregister-ScheduledTask -TaskName "Office_Workspace_Weekly_Maintenance" -Confirm:$false
```

或在任务计划程序中右键 → "删除"

---

## 需要帮助？

如果以上方法都失败了，可以考虑：
1. 不使用计划任务，定期手动运行 `run_maintenance.bat`
2. 检查 Windows 事件查看器中的错误日志
3. 联系系统管理员

---

**提示**: 手动创建任务虽然步骤多，但更可靠，可以看到每个步骤的详细配置。
