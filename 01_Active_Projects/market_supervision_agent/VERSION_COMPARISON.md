# 版本对比与迁移指南

## 🆚 v2.0 vs v3.0 功能对比

### 核心差异

| 特性 | v2.0（颜色标记版） | v3.0（Jinja2模板版） |
|------|------------------|---------------------|
| **模板制作** | 需要设置字体颜色（红/绿） | 直接输入 `{{变量名}}` |
| **字段识别** | 基于字体颜色识别 | 基于变量名匹配 |
| **配置复杂度** | 需要字段映射配置 | 无需映射，直接使用 |
| **条件逻辑** | 不支持 | 支持完整 Jinja2 语法 |
| **循环功能** | 不支持 | 支持 `{% for %}` 循环 |
| **模板维护** | 需要小心设置颜色 | 直接编辑文本 |
| **学习曲线** | 需要理解颜色规则 | 需要学习 Jinja2 语法 |
| **灵活性** | 受限于颜色方案 | 几乎无限可能 |
| **技术栈** | python-docx 原生 | python-docx-template |

---

## 📝 详细对比

### 1. 模板制作

#### v2.0 颜色标记版

**优点**：
- ✅ 直观：用颜色区分常量和变量
- ✅ 可视化：一目了然看到哪些会变化

**缺点**：
- ❌ 需要手动设置字体颜色
- ❌ 容易出错（颜色设置错误）
- ❌ 无法表达复杂逻辑
- ❌ 模板修改麻烦

**示例**：
```
[红色字体] {{business_name}}
[绿色字体] 个体工商户
```

#### v3.0 Jinja2 模板版

**优点**：
- ✅ 简单：直接输入变量名
- ✅ 强大：支持条件判断和循环
- ✅ 灵活：可以用表达式
- ✅ 标准：使用业界标准模板语法

**缺点**：
- ❌ 需要学习 Jinja2 语法（但很简单）

**示例**：
```
个体工商户名称：{{business_name}}
{% if operation_period == '长期' %}
经营期限：长期
{% else %}
经营期限：{{operation_period}}
{% endif %}

经营范围：
{% for item in business_scope_list %}
- {{item}}
{% endfor %}
```

---

### 2. 数据处理

#### v2.0
```python
# 需要字段映射
field_mappings = {
    "个体工商户名称": "business_name",
    "经营者姓名": "operator_name",
    # ... 更多映射
}

# 复杂的颜色检测逻辑
def is_red_font(run):
    if run.font.color and run.font.color.rgb:
        r, g, b = run.font.color.rgb
        return r == 255 and g == 0 and b == 0
    return False
```

#### v3.0
```python
# 直接使用变量名，无需映射
context = {
    'business_name': '张三便利店',
    'operator_name': '张三'
}

# 简单直接的渲染
tpl.render(context)
```

---

### 3. 高级功能对比

| 功能 | v2.0 | v3.0 |
|------|------|------|
| 条件显示 | ❌ 不支持 | ✅ `{% if %}` |
| 列表循环 | ❌ 不支持 | ✅ `{% for %}` |
| 默认值 | ⚠️ 需要代码处理 | ✅ `{{var\|default('value')}}` |
| 表达式计算 | ❌ 不支持 | ✅ `{{a + b}}` |
| 表格合并 | ⚠️ 复杂 | ✅ `{% vm %}`, `{% hm %}` |
| 嵌套循环 | ❌ 不支持 | ✅ 支持 |
| 过滤器 | ❌ 不支持 | ✅ 支持 50+ 过滤器 |

---

## 🔄 迁移指南

### 情况1：简单模板迁移

**原模板（v2.0）**：
```
[红色] {{business_name}}
[绿色] 个体工商户
[红色] {{operator_name}}
```

**新模板（v3.0）**：
```
个体工商户名称：{{business_name}}
经营者姓名：{{operator_name}}
```

### 情况2：带条件逻辑的迁移

**v2.0 方式**（需要在代码中处理）：
```python
# 代码中处理
if operation_period == '长期':
    fill_with_default()
else:
    fill_with_value()
```

**v3.0 方式**（在模板中直接写）：
```
{% if operation_period == '长期' %}
经营期限：长期
{% else %}
经营期限：{{operation_period}}
{% endif %}
```

### 情况3：列表数据的迁移

**v2.0 方式**（需要预处理）：
```python
# 代码中分号分隔
scope = "食品销售；日用百货"
# 需要手动处理
```

**v3.0 方式**（直接在模板中循环）：
```
经营范围：
{% for item in business_scope_list %}
- {{item}}
{% endfor %}
```

---

## 📊 性能对比

| 指标 | v2.0 | v3.0 |
|------|------|------|
| 渲染速度 | 快 | 快（几乎相同） |
| 内存占用 | 中等 | 中等 |
| 模板大小 | 小 | 小 |
| 依赖包 | python-docx | python-docx + jinja2 |
| 启动时间 | 快 | 快 |

---

## 🎯 选择建议

### 选择 v2.0（颜色标记版）如果：
- ✅ 已经有大量颜色标记模板
- ✅ 团队熟悉颜色标记方式
- ✅ 不需要复杂逻辑
- ✅ 快速简单项目

### 选择 v3.0（Jinja2模板版）如果：
- ✅ 需要条件判断
- ✅ 需要列表循环
- ✅ 新项目或愿意迁移
- ✅ 需要更灵活的模板
- ✅ 希望使用业界标准

---

## 🚀 快速迁移步骤

### 第1步：创建新模板

1. 打开旧版模板文件
2. 找到所有红色字体内容
3. 改为 `{{变量名}}` 格式
4. 删除颜色标记
5. 保存为新文件

### 第2步：验证变量

```bash
python jinja2_filler.py --validate 新模板.docx
```

### 第3步：测试数据

```bash
python jinja2_filler.py --test
```

### 第4步：迁移数据

旧版数据可以直接使用，无需修改。

### 第5步：批量处理

```bash
python jinja2_filler.py --batch data_list.json
```

---

## 📚 学习资源

### Jinja2 基础语法（5分钟）

```jinja2
{# 这是注释 #}

{# 变量 #}
{{variable_name}}

{# 条件 #}
{% if condition %}
  内容
{% endif %}

{# 循环 #}
{% for item in list %}
  {{item}}
{% endfor %}

{# 过滤器 #}
{{text|upper}}
{{price|default('0.00')}}
```

### 常用过滤器

```jinja2
{{text|upper}}           {# 转大写 #}
{{text|lower}}           {# 转小写 #}
{{text|default('值')}}   {# 默认值 #}
{{list|length}}          {# 列表长度 #}
{{list|first}}           {# 第一项 #}
{{list|join(',')}}       {# 连接字符串 #}
```

---

## 💡 实用示例

### 示例1：条件显示电话

```
联系电话：{% if phone %}{{phone}}{% else %}未提供{% endif %}
```

### 示例2：经营范围循环

```
经营范围：
{% for item in business_scope_list %}
{{loop.index}}. {{item}}
{% endfor %}
```

输出：
```
经营范围：
1. 食品销售
2. 日用百货
3. 烟草制品
```

### 示例3：格式化日期

```
申请日期：{{today_year}}年{{today_month}}月{{today_day}}日
```

### 示例4：计算总金额

```
总金额：{{unit_price * quantity}}元
```

---

## 🎉 总结

**v3.0 带来的核心价值**：

1. **更简单**：无需设置颜色，直接写变量名
2. **更强大**：支持条件、循环等完整逻辑
3. **更灵活**：几乎可以实现任何模板需求
4. **更标准**：使用业界标准的 Jinja2 语法
5. **易维护**：模板清晰明了，易于修改

**迁移建议**：

- 小项目：继续用 v2.0
- 新项目：直接用 v3.0
- 复杂需求：必须用 v3.0
- 长期维护：推荐 v3.0

---

**开始使用 v3.0**：
```bash
python jinja2_filler.py --test
```

**查看详细文档**：
[完整使用指南](JINJA2_VERSION_GUIDE.md)
