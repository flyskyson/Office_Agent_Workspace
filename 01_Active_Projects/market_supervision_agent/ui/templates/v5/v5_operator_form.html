{% extends "v5/v5_base.html" %}

{% block title %}{{ 'ç¼–è¾‘' if operator else 'æ–°å»º' }}ç»è¥æˆ· - å¸‚åœºç›‘ç®¡æ™ºèƒ½ä½“ v5.0{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ 'ç¼–è¾‘' if operator else 'æ–°å»º' }}ç»è¥æˆ·</h2>

    <!-- OCR ä¸Šä¼ åŒºåŸŸ -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="color: white; margin: 0 0 15px 0; font-size: 18px;">ğŸ“· OCR æ™ºèƒ½è¯†åˆ« - ä¸Šä¼ è¯ä»¶è‡ªåŠ¨å¡«å†™</h3>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <!-- èº«ä»½è¯æ­£é¢ -->
            <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 6px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">èº«ä»½è¯æ­£é¢</label>
                <input type="file" id="ocr_id_card_front" accept="image/*"
                       style="width: 100%; font-size: 12px;">
                <button type="button" onclick="ocrUpload('id_card_front')"
                        style="width: 100%; margin-top: 8px; padding: 6px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    è¯†åˆ«
                </button>
            </div>

            <!-- èº«ä»½è¯èƒŒé¢ -->
            <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 6px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">èº«ä»½è¯èƒŒé¢</label>
                <input type="file" id="ocr_id_card_back" accept="image/*"
                       style="width: 100%; font-size: 12px;">
                <button type="button" onclick="ocrUpload('id_card_back')"
                        style="width: 100%; margin-top: 8px; padding: 6px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    è¯†åˆ«
                </button>
            </div>

            <!-- ç§ŸèµåˆåŒ -->
            <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 6px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">ç§ŸèµåˆåŒ</label>
                <input type="file" id="ocr_lease_contract" accept="image/*"
                       style="width: 100%; font-size: 12px;">
                <button type="button" onclick="ocrUpload('lease_contract')"
                        style="width: 100%; margin-top: 8px; padding: 6px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    è¯†åˆ«
                </button>
            </div>

            <!-- æˆ¿äº§è¯æ˜ -->
            <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 6px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">æˆ¿äº§è¯æ˜</label>
                <input type="file" id="ocr_property_cert" accept="image/*"
                       style="width: 100%; font-size: 12px;">
                <button type="button" onclick="ocrUpload('property_cert')"
                        style="width: 100%; margin-top: 8px; padding: 6px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    è¯†åˆ«
                </button>
            </div>
        </div>

        <div id="ocr_status" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.9); border-radius: 4px; display: none;">
            <span id="ocr_status_text" style="color: #333;"></span>
        </div>
    </div>

    <form method="POST" style="max-width: 800px;">
        <h3 style="margin: 30px 0 20px; color: #1890ff;">ä¸€ã€åŸºæœ¬ä¿¡æ¯</h3>

        <div class="form-row">
            <div class="form-group">
                <label for="operator_name">ç»è¥è€…å§“å *</label>
                <input type="text" id="operator_name" name="operator_name"
                       value="{{ form_data.operator_name if form_data else (operator.operator_name if operator else '') }}"
                       required>
            </div>

            <div class="form-group">
                <label for="id_card">èº«ä»½è¯å· *</label>
                <input type="text" id="id_card" name="id_card"
                       value="{{ form_data.id_card if form_data else (operator.id_card if operator else '') }}"
                       required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="phone">è”ç³»ç”µè¯</label>
                <input type="tel" id="phone" name="phone"
                       value="{{ form_data.phone if form_data else (operator.phone if operator else '') }}">
            </div>

            <div class="form-group">
                <label for="email">ç”µå­é‚®ç®±</label>
                <input type="email" id="email" name="email"
                       value="{{ form_data.email if form_data else (operator.email if operator else '') }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="gender">æ€§åˆ«</label>
                <select id="gender" name="gender">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="ç”·" {{ 'selected' if (form_data.gender if form_data else (operator.gender if operator else '')) == 'ç”·' else '' }}>ç”·</option>
                    <option value="å¥³" {{ 'selected' if (form_data.gender if form_data else (operator.gender if operator else '')) == 'å¥³' else '' }}>å¥³</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nation">æ°‘æ—</label>
                <input type="text" id="nation" name="nation"
                       value="{{ form_data.nation if form_data else (operator.nation if operator else '') }}"
                       placeholder="å¦‚ï¼šæ±‰æ—">
            </div>
        </div>

        <div class="form-group">
            <label for="address">ç»è¥è€…ä½å€</label>
            <input type="text" id="address" name="address"
                   value="{{ form_data.address if form_data else (operator.address if operator else '') }}">
        </div>

        <h3 style="margin: 30px 0 20px; color: #1890ff;">äºŒã€ç»è¥ä¿¡æ¯</h3>

        <div class="form-group">
            <label for="business_name">ä¸ªä½“å·¥å•†æˆ·åç§°</label>
            <input type="text" id="business_name" name="business_name"
                   value="{{ form_data.business_name if form_data else (operator.business_name if operator else '') }}"
                   placeholder="å¦‚ï¼šç‰æ—å¸‚å…´ä¸šå¿å¼ ä¸‰ä¾¿åˆ©åº—ï¼ˆä¸ªä½“å·¥å•†æˆ·ï¼‰">
        </div>

        <div class="form-group">
            <label for="business_address">ç»è¥åœºæ‰€åœ°å€ *</label>
            <input type="text" id="business_address" name="business_address"
                   value="{{ form_data.business_address if form_data else (operator.business_address if operator else '') }}"
                   required>
        </div>

        <div class="form-group">
            <label for="business_address_detail">è¯¦ç»†åœ°å€</label>
            <input type="text" id="business_address_detail" name="business_address_detail"
                   value="{{ form_data.business_address_detail if form_data else (operator.business_address_detail if operator else '') }}">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="business_area">ç»è¥é¢ç§¯</label>
                <input type="text" id="business_area" name="business_area"
                       value="{{ form_data.business_area if form_data else (operator.business_area if operator else '') }}"
                       placeholder="å¦‚ï¼š50å¹³æ–¹ç±³">
            </div>

            <div class="form-group">
                <label for="business_type">ç»è¥ç±»å‹</label>
                <select id="business_type" name="business_type">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="ä¸ªä½“ç»è¥" {{ 'selected' if (form_data.business_type if form_data else (operator.business_type if operator else '')) == 'ä¸ªä½“ç»è¥' else '' }}>ä¸ªä½“ç»è¥</option>
                    <option value="å®¶åº­ç»è¥" {{ 'selected' if (form_data.business_type if form_data else (operator.business_type if operator else '')) == 'å®¶åº­ç»è¥' else '' }}>å®¶åº­ç»è¥</option>
                </select>
            </div>
        </div>

        <h3 style="margin: 30px 0 20px; color: #1890ff;">ä¸‰ã€ç»è¥èŒƒå›´</h3>

        <div class="form-group">
            <label for="business_scope">ç»è¥èŒƒå›´ï¼ˆå®Œæ•´ï¼‰</label>
            <textarea id="business_scope" name="business_scope" rows="3"
                      placeholder="å¦‚ï¼šæ—¥ç”¨ç™¾è´§ã€çƒŸé…’é›¶å”®">{{ form_data.business_scope if form_data else (operator.business_scope if operator else '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="business_scope_licensed">è®¸å¯ç»è¥é¡¹ç›®</label>
            <input type="text" id="business_scope_licensed" name="business_scope_licensed"
                   value="{{ form_data.business_scope_licensed if form_data else (operator.business_scope_licensed if operator else '') }}">
        </div>

        <div class="form-group">
            <label for="business_scope_general">ä¸€èˆ¬ç»è¥é¡¹ç›®</label>
            <input type="text" id="business_scope_general" name="business_scope_general"
                   value="{{ form_data.business_scope_general if form_data else (operator.business_scope_general if operator else '') }}">
        </div>

        <h3 style="margin: 30px 0 20px; color: #1890ff;">å››ã€ä»ä¸šå’Œèµ„é‡‘</h3>

        <div class="form-row">
            <div class="form-group">
                <label for="employee_count">ä»ä¸šäººæ•°</label>
                <input type="number" id="employee_count" name="employee_count"
                       value="{{ form_data.employee_count if form_data else (operator.employee_count if operator else '1') }}"
                       min="1" value="1">
            </div>

            <div class="form-group">
                <label for="registered_capital">æ³¨å†Œèµ„é‡‘ï¼ˆä¸‡å…ƒï¼‰</label>
                <input type="text" id="registered_capital" name="registered_capital"
                       value="{{ form_data.registered_capital if form_data else (operator.registered_capital if operator else '0.01') }}">
            </div>
        </div>

        <h3 style="margin: 30px 0 20px; color: #1890ff;">äº”ã€åœºæ‰€ä¿¡æ¯</h3>

        <div class="form-group">
            <label for="property_owner">æˆ¿äº§æ‰€æœ‰äºº/æˆ¿ä¸œ</label>
            <input type="text" id="property_owner" name="property_owner"
                   value="{{ form_data.property_owner if form_data else (operator.property_owner if operator else '') }}">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="lease_start">ç§Ÿèµå¼€å§‹æ—¥æœŸ</label>
                <input type="date" id="lease_start" name="lease_start"
                       value="{{ form_data.lease_start if form_data else (operator.lease_start if operator else '') }}">
            </div>

            <div class="form-group">
                <label for="lease_end">ç§Ÿèµç»“æŸæ—¥æœŸ</label>
                <input type="date" id="lease_end" name="lease_end"
                       value="{{ form_data.lease_end if form_data else (operator.lease_end if operator else '') }}">
            </div>
        </div>

        <div class="form-group">
            <label for="rent_amount">ç§Ÿé‡‘é‡‘é¢</label>
            <input type="text" id="rent_amount" name="rent_amount"
                   value="{{ form_data.rent_amount if form_data else (operator.rent_amount if operator else '') }}"
                   placeholder="å¦‚ï¼š2000å…ƒ/æœˆ">
        </div>

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <a href="{{ url_for('index') }}" class="btn" style="margin-left: 10px;">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<script>
// OCR ä¸Šä¼ å’Œè¯†åˆ«å‡½æ•°
async function ocrUpload(docType) {
    const fileInput = document.getElementById('ocr_' + docType);
    const file = fileInput.files[0];

    if (!file) {
        showOcrStatus('è¯·å…ˆé€‰æ‹©æ–‡ä»¶!', 'error');
        return;
    }

    showOcrStatus(`æ­£åœ¨è¯†åˆ« ${getDocTypeName(docType)}...`, 'info');

    const formData = new FormData();
    formData.append('file', file);
    formData.append('doc_type', docType);

    try {
        const response = await fetch('/api/ocr_upload', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
            // è‡ªåŠ¨å¡«å……è¡¨å•
            fillForm(result.data);
            showOcrStatus(`âœ… ${getDocTypeName(docType)} è¯†åˆ«æˆåŠŸ! å·²è‡ªåŠ¨å¡«å……è¡¨å•`, 'success');
        } else {
            showOcrStatus(`âŒ è¯†åˆ«å¤±è´¥: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('OCR error:', error);
        showOcrStatus(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
}

// æ˜¾ç¤ºOCRçŠ¶æ€
function showOcrStatus(message, type) {
    const statusDiv = document.getElementById('ocr_status');
    const statusText = document.getElementById('ocr_status_text');

    statusDiv.style.display = 'block';
    statusText.textContent = message;

    // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
    if (type === 'success') {
        statusDiv.style.background = '#d4edda';
        statusText.style.color = '#155724';
    } else if (type === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusText.style.color = '#721c24';
    } else {
        statusDiv.style.background = '#fff3cd';
        statusText.style.color = '#856404';
    }
}

// è·å–æ–‡æ¡£ç±»å‹åç§°
function getDocTypeName(docType) {
    const names = {
        'id_card_front': 'èº«ä»½è¯æ­£é¢',
        'id_card_back': 'èº«ä»½è¯èƒŒé¢',
        'lease_contract': 'ç§ŸèµåˆåŒ',
        'property_cert': 'æˆ¿äº§è¯æ˜'
    };
    return names[docType] || docType;
}

// è‡ªåŠ¨å¡«å……è¡¨å•
function fillForm(data) {
    // åŸºæœ¬ä¿¡æ¯
    if (data.operator_name) {
        document.getElementById('operator_name').value = data.operator_name;
    }
    if (data.id_card) {
        document.getElementById('id_card').value = data.id_card;
    }
    if (data.phone) {
        document.getElementById('phone').value = data.phone;
    }
    if (data.gender) {
        document.getElementById('gender').value = data.gender;
    }
    if (data.nation) {
        document.getElementById('nation').value = data.nation;
    }
    if (data.address) {
        document.getElementById('address').value = data.address;
    }

    // ç»è¥ä¿¡æ¯
    if (data.business_name) {
        document.getElementById('business_name').value = data.business_name;
    }
    if (data.business_address) {
        document.getElementById('business_address').value = data.business_address;
    }

    // åœºæ‰€ä¿¡æ¯
    if (data.property_owner) {
        document.getElementById('property_owner').value = data.property_owner;
    }
    if (data.lease_start) {
        document.getElementById('lease_start').value = data.lease_start;
    }
    if (data.lease_end) {
        document.getElementById('lease_end').value = data.lease_end;
    }
    if (data.rent_amount) {
        document.getElementById('rent_amount').value = data.rent_amount;
    }
}
</script>
{% endblock %}
