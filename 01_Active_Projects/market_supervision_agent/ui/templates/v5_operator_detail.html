{% extends "v5/v5_base.html" %}

{% block title %}{{ operator.operator_name }} - 经营户详情{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>{{ operator.operator_name }}</h1>
    <div>
        <a href="{{ url_for('edit_operator', operator_id=operator.id) }}" class="btn btn-primary">编辑</a>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <h3 style="color: #1890ff; margin-bottom: 15px;">基本信息</h3>
        <table style="width: 100%;">
            <tr>
                <td style="width: 100px; color: #666;">身份证号</td>
                <td>{{ operator.id_card }}</td>
            </tr>
            <tr>
                <td style="color: #666;">联系电话</td>
                <td>{{ operator.phone or '-' }}</td>
            </tr>
            <tr>
                <td style="color: #666;">电子邮箱</td>
                <td>{{ operator.email or '-' }}</td>
            </tr>
            <tr>
                <td style="color: #666;">住址</td>
                <td>{{ operator.address or '-' }}</td>
            </tr>
        </table>
    </div>

    <div class="card">
        <h3 style="color: #1890ff; margin-bottom: 15px;">经营信息</h3>
        <table style="width: 100%;">
            <tr>
                <td style="width: 100px; color: #666;">店名</td>
                <td>{{ operator.business_name or '-' }}</td>
            </tr>
            <tr>
                <td style="color: #666;">经营地址</td>
                <td>{{ operator.business_address or '-' }}</td>
            </tr>
            <tr>
                <td style="color: #666;">经营范围</td>
                <td>{{ operator.business_scope or '-' }}</td>
            </tr>
            <tr>
                <td style="color: #666;">从业人数</td>
                <td>{{ operator.employee_count or 1 }} 人</td>
            </tr>
        </table>
    </div>

    <div class="card">
        <h3 style="color: #1890ff; margin-bottom: 15px;">状态</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>申请书生成</span>
                <span class="badge {{ 'badge-success' if operator.application_generated else 'badge-warning' }}">
                    {{ '已生成' if operator.application_generated else '待生成' }}
                </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>打印状态</span>
                <span class="badge {{ 'badge-success' if operator.printed else 'badge-warning' }}">
                    {{ '已打印' if operator.printed else '待打印' }}
                </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>签字盖章</span>
                <span class="badge {{ 'badge-success' if operator.signed else 'badge-warning' }}">
                    {{ '已完成' if operator.signed else '待完成' }}
                </span>
            </div>
        </div>
    </div>
</div>

{% if name_validation %}
<div class="card">
    <h3>名称验证结果</h3>
    <div style="display: flex; gap: 20px; margin-top: 15px;">
        <div>
            <span style="color: #666;">格式正确：</span>
            <span class="badge {{ 'badge-success' if name_validation.format_correct else 'badge-warning' }}">
                {{ '是' if name_validation.format_correct else '否' }}
            </span>
        </div>
        <div>
            <span style="color: #666;">是否有效：</span>
            <span class="badge {{ 'badge-success' if name_validation.is_valid else 'badge-warning' }}">
                {{ '是' if name_validation.is_valid else '否' }}
            </span>
        </div>
        <div>
            <span style="color: #666;">可信度：</span>
            <strong>{{ "%.2f"|format(name_validation.confidence) }}</strong>
        </div>
    </div>
    {% if name_validation.warnings %}
    <div style="margin-top: 15px; padding: 10px; background: #fffbe6; border-radius: 4px;">
        <strong>警告：</strong>{{ ', '.join(name_validation.warnings) }}
    </div>
    {% endif %}
    {% if name_validation.suggestions %}
    <div style="margin-top: 10px; padding: 10px; background: #e6f7ff; border-radius: 4px;">
        <strong>建议：</strong>{{ ', '.join(name_validation.suggestions) }}
    </div>
    {% endif %}
</div>
{% endif %}

{% if name_suggestions %}
<div class="card">
    <h3>名称建议</h3>
    <table style="margin-top: 15px;">
        <thead>
            <tr>
                <th>推荐名称</th>
                <th>字号</th>
                <th>评分</th>
                <th>理由</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for suggestion in name_suggestions[:5] %}
            <tr>
                <td>{{ suggestion.full_name }}</td>
                <td>{{ suggestion.trade_name }}</td>
                <td><strong>{{ suggestion.score }}</strong></td>
                <td style="font-size: 12px; color: #666;">{{ ', '.join(suggestion.reasons) }}</td>
                <td>
                    <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;"
                            onclick="updateBusinessName('{{ suggestion.full_name }}')">
                        使用此名称
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="card">
    <h3>操作</h3>
    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
        {% if not operator.application_generated %}
        <form method="POST" action="{{ url_for('generate_application', operator_id=operator.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-success">生成申请书</button>
        </form>
        {% else %}
        <a href="{{ url_for('download_file', filepath=operator.application_path) }}" class="btn btn-success">
            下载申请书
        </a>
        {% endif %}

        {% if operator.application_generated and not operator.printed %}
        <form method="POST" action="{{ url_for('print_application', operator_id=operator.id) }}"
              style="display: inline;" onsubmit="return markPrinted();">
            <button type="submit" class="btn btn-primary">标记为已打印</button>
        </form>
        {% endif %}

        {% if operator.printed and not operator.signed %}
        <form method="POST" action="{{ url_for('mark_signed', operator_id=operator.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-primary">标记为已签字盖章</button>
        </form>
        {% endif %}
    </div>
</div>

<script>
function updateBusinessName(name) {
    if (confirm('确定要使用名称：' + name + ' 吗？')) {
        fetch('/api/operator/{{ operator.id }}/validate_name', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ business_name: name })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('名称验证通过！即将跳转到编辑页面...');
                window.location.href = '{{ url_for("edit_operator", operator_id=operator.id) }}';
            } else {
                alert('名称验证失败：' + (data.warnings || []).join(', '));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('验证失败，请重试');
        });
    }
}

function markPrinted() {
    return confirm('确定标记为已打印吗？');
}
</script>
{% endblock %}
