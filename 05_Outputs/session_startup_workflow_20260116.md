# 🔄 Claude Code 会话启动流程详解

**版本**: GLM-4.7 (Claude Code)
**更新日期**: 2026-01-16

---

## 📋 完整启动流程

```
┌─────────────────────────────────────────────────────────────────┐
│              用户启动 Claude Code                               │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤1: 读取 CLAUDE.md                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  位置: 项目根目录 / CLAUDE.md                                   │
│  作用: 项目核心配置文件                                       │
│                                                                 │
│  读取内容:                                                     │
│  ├── 项目类型: Python 办公自动化工具集                         │
│  ├── 主要框架: Streamlit, Flask, Playwright, LangGraph         │
│  ├── Python版本: 3.9+ (推荐 3.12)                             │
│  ├── 当前版本: v2.0.0                                           │
│  ├── 快速导航 (30秒)                                            │
│  ├── 核心目录结构                                               │
│  ├── 可用技能列表                                               │
│  └── 相关文档索引                                               │
│                                                                 │
│  加载方式:                                                     │
│  └── 自动读取，作为第一层上下文                                │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤2: 读取技能文档 (Skills/)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  位置: skills/                                                 │
│  作用: 定义技能触发规则和执行流程                             │
│                                                                 │
│  读取技能:                                                     │
│  ├── skills/super-butler/SKILL.md                              │
│  │   ├── 触发关键词: 管家、超级管家、工作区状态                   │
│  │   └── 执行步骤: 工作区概览 + 智能推荐                         │
│  │                                                               │
│  ├── skills/idea-to-product/SKILL.md                            │
│  │   ├── 触发关键词: 我有个想法、想添加功能                     │
│  │   └── 执行步骤: 澄清 → 探索 → 设计 → 原型 → 验证             │
│  │                                                               │
│  ├── skills/application-generator/SKILL.md                       │
│  │   ├── 触发关键词: 申请书、填写申请表                           │
│  │   └── 执行步骤: OCR识别 + 模板填充 + 文档生成                 │
│  │                                                               │
│  ├── skills/license-organizer/SKILL.md                           │
│  │   ├── 触发关键词: 整理证照、归类文件                           │
│  │   └── 执行步骤: 文件分类 + 自动归档                           │
│  │                                                               │
│  └── skills/knowledge-indexer/SKILL.md                           │
│      ├── 触发关键词: 索引笔记、更新知识库                         │
│      └── 执行步骤: 扫描 + 向量化 + 索引                           │
│                                                                 │
│  加载方式:                                                     │
│  ├── 遍历 skills/ 目录                                         │
│  ├── 读取每个 SKILL.md                                          │
│  ├── 解析触发关键词                                              │
│  └── 建立技能索引                                                │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤3: 加载记忆系统                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  位置: 06_Learning_Journal/claude_memory/                       │
│  作用: 持久化记忆存储和检索                                     │
│                                                                 │
│  读取记忆文件:                                                 │
│  ├── contexts.json              # 上下文记忆 (25条)             │
│  ├── decisions.json             # 决策记录 (6条)               │
│  ├── conversations.json          # 对话历史 (1条)              │
│  └── user_interests.json         # 用户兴趣 (42+10关键词)      │
│                                                                 │
│  加载内容:                                                     │
│  ├── 角色定义                                                    │
│  │   ├── Claude Code核心角色定义                               │
│  │   ├── 三大核心: 协作、自动化、学习                         │
│  │   └── 用户期望: 编程、务实、简洁                           │
│  │                                                               │
│  ├── 工作偏好                                                    │
│  │   ├── 优先方向: 协作自动化                                 │
│  │   ├── 主动性: 高主动性，先斩后奏                           │
│   │   ├── 失败观: 失败是学习机会                               │
│   │   └── 交流方式: 直接输出结果                               │
│  │                                                               │
│  ├── 高优先级记忆                                              │
│  │   ├── 自动记忆加载机制实现                                 │
│   │   ├── 效率监控系统                                         │
│   │   ├── 记忆系统优化                                          │
│   │   └── 技能集成经验                                         │
│  │                                                               │
│  └── 用户兴趣                                                    │
│      ├── 长期: AI, Python, MCP, 向量化... (42个)                │
│      └── 短期: GPT-5, Claude 4, AI Agent... (10个)               │
│                                                                 │
│  加载方式:                                                     │
│  └── ClaudeMemory.recall() 按优先级检索                        │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤4: 加载 MCP 服务器配置                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  位置: .claude/settings.local.json                              │
│  作用: MCP 服务器配置                                            │
│                                                                 │
│  读取配置:                                                     │
│  ├── mcp-hot-news              # 热点新闻 (13+平台)            │
│  ├── wopal-hotnews             # 中文热点 (9平台)               │
│  └── skill-seeker              # 技能生成工具 (17工具)         │
│                                                                 │
│  初始化服务器:                                               │
│  └── stdio 通信方式启动 MCP 服务器                            │
│      ├── skill-seeker (FastMCP)                               │
│      ├── mcp-hot-news                                         │
│      └── wopal-hotnews                                        │
│                                                                 │
│  可用工具:                                                     │
│  ├── 17 个 Skill Seeker 工具                                 │
│  ├── 热点新闻获取                                              │
│  └── 文档处理能力                                              │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤5: 加载已安装技能                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  位置: ~/.claude/skills/                                      │
│  作用: 用户安装的自定义技能                                   │
│                                                                 │
│  已安装技能 (8个):                                             │
│  ├── office-agent-workspace      # 工作区主技能                 │
│  ├── market-supervision-agent    # 市场监管智能体               │
│  ├── memory-agent                # 记忆助手                     │
│  ├── file-organizer               # 文件整理工具                   │
│  ├── smart-tools                 # 智能工具集                    │
│  ├── workflow-engine            # 工作流引擎                    │
│  ├── agent-toolkit               # AgentTool框架                 │
│  └── claude-memory               # Claude记忆系统                │
│                                                                 │
│  加载方式:                                                     │
│  ├── 扫描技能目录                                              │
│  ├── 读取 SKILL.md                                            │
│  └── 建立技能索引 (@技能名 调用)                               │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤6: 构建上下文模型                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  整合所有信息:                                                │
│  ├── 项目配置 (CLAUDE.md)                                       │
│  ├── 技能定义 (Skills/)                                         │
│  ├── 记忆系统 (claude_memory/)                                  │
│  ├── MCP 工具 (settings.local.json)                            │
│  └── 用户技能 (~/.claude/skills/)                              │
│                                                                 │
│  构建上下文:                                                   │
│  ├── 工作区资产清单 (4智能体 + 5新闻 + 39工具)                   │
│  ├── 用户偏好和兴趣                                            │
│  ├── 历史决策和经验                                            │
│  ├── 可用工具和API                                              │
│  └── 技能触发规则                                              │
│                                                                 │
│  优化响应策略:                                                 │
│  ├── 智能推荐引擎准备                                          │
│  ├── 同义词扩展准备                                            │
│  ├── 上下文理解准备                                          │
│  └── 个性化响应准备                                          │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤7: 显示欢迎信息 (可选)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  如果配置了 session_initializer.py:                            │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 🤖 Claude Code 会话初始化                             │  │
│  │ ════════════════════════════════════════════════════════│  │
│  │ ⏰ 时间: 2026-01-16 10:00:00                          │  │
│  │ 📂 工作区: c:\Users\flyskyson\Office_Agent_Workspace  │  │
│  │ ════════════════════════════════════════════════════════│  │
│  │                                                         │  │
│  │ 🎯 我的角色                                              │  │
│  │ ───────────────────────────────────────────────────  │  │
│  │    "记忆增强的协作伙伴，专注于自动化和效率提升"       │  │
│  │                                                         │  │
│  │ 💡 三大核心:                                              │  │
│  │    • 协作: 主动分担，无缝配合                             │  │
│  │    • 自动化: 先斩后奏，持续优化                           │  │
│  │    • 学习: 记忆一切，快速成长                             │  │
│  │                                                         │  │
│  │ ⭐ 高优先级记忆:                                        │  │
│  │    1. 自动记忆加载机制实现                             │  │
│  │    2. 效率监控系统                                      │  │
│  │    3. 记忆系统优化                                       │  │
│  │                                                         │  │
│  │ 📊 记忆统计:                                             │  │
│  │    上下文: 25 条                                          │  │
│  │    决策: 6 条                                             │  │
│  │    对话: 1 条                                             │  │
│  │    大小: 28.5 KB                                          │  │
│  │                                                         │  │
│  │ ════════════════════════════════════════════════════════│  │
│  │ ✅ 记忆加载完成，准备服务                                │  │
│  │ ════════════════════════════════════════════════════════│  │
│  │                                                         │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│  否则 (默认):                                                  │
│  └── 静默启动，等待用户输入                                      │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              步骤8: 准备就绪，等待用户输入                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  系统状态:                                                     │
│  ✅ 项目上下文已加载                                           │
│  ✅ 技能系统已激活                                             │
│  ✅ 记忆系统已就绪                                             │
│  ✅ MCP工具已连接                                              │
│  ✅ 用户技能已加载                                             │
│                                                                 │
│  准备服务:                                                     │
│  ├── 智能推荐引擎待命                                          │
│  ├── 技能触发系统待命                                          │
│  ├── 记忆记录系统待命                                          │
│  └── 工作流引擎待命                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 关键加载优先级

```
1. CLAUDE.md (项目配置)
   ↓
2. skills/ (技能定义)
   ↓
3. claude_memory/ (记忆系统)
   ↓
4. .claude/settings.local.json (MCP配置)
   ↓
5. ~/.claude/skills/ (用户技能)
   ↓
6. 构建完整上下文
```

---

## 💡 加载机制说明

### 1. CLAUDE.md 加载

**作用**: 提供项目基础信息

**触发**: 自动读取，会话开始时

**内容**:
```yaml
项目类型: Python 办公自动化工具集
主要框架: Streamlit, Flask, Playwright, LangGraph
Python版本: 3.9+ (推荐 3.12)
当前版本: v2.0.0
核心功能:
  - SQLite MCP: 统一数据访问层
  - ConfigCenter: 分层配置系统
  - AgentSupervisor: 智能体协作编排
  - Workflow Templates: 可复用工作流
```

### 2. 技能系统加载

**作用**: 自动识别用户意图并触发相应技能

**触发**: 关键词匹配

**技能路由**:
```
"管家" → super-butler/SKILL.md
"想法" → idea-to-product/SKILL.md
"申请书" → application-generator/SKILL.md
"证照" → license-organizer/SKILL.md
"索引" → knowledge-indexer/SKILL.md
```

### 3. 记忆系统加载

**作用**: 记住用户偏好、历史决策、对话上下文

**触发**: 自动检索

**记忆类型**:
```python
# 角色定义
contexts = memory.recall("Claude Code核心角色定义")

# 高优先级
high_priority = memory.recall_high_priority(limit=10)

# 用户偏好
prefs = memory.store.memory.get('preferences', {})

# 用户兴趣
interests = {
    "long_term": ["AI", "Python", "MCP", ...],  # 42个
    "short_term": ["GPT-5", "Claude 4", ...]   # 10个
}
```

### 4. MCP 工具加载

**作用**: 提供17个技能生成工具和新闻获取能力

**配置**: `.claude/settings.local.json`

**服务器**:
```json
{
  "skill-seeker": {
    "command": "python",
    "args": ["-m", "skill_seekers.mcp.server_fastmcp"]
  },
  "mcp-hot-news": {
    "command": "npx",
    "args": ["-y", "mcp-hot-news"]
  },
  "wopal-hotnews": {
    "command": "npx",
    "args": ["-y", "@wopal/mcp-server-hotnews"]
  }
}
```

### 5. 用户技能加载

**作用**: 扩展 Claude 能力，支持 @技能名 调用

**位置**: `~/.claude/skills/`

**调用方式**:
```
@office-agent-workspace 帮我创建新智能体
@market-supervision-agent 填写申请书
@memory-agent 搜索笔记
```

---

## 🚀 优化启动速度

### 快速启动模式

如果需要更快的启动速度，可以：

1. **减少记忆加载**
```python
# 只加载高优先级记忆
high_priority = memory.recall_high_priority(limit=5)
```

2. **延迟加载技能**
```python
# 按需加载技能，而非启动时全部加载
```

3. **禁用欢迎信息**
```python
# 静默启动
context = initializer.initialize_session(show_details=False)
```

---

## 📊 加载内容统计

| 类别 | 数量 | 大小 |
|------|------|------|
| **CLAUDE.md** | 1文件 | ~300行 |
| **技能文件** | 5个技能 | ~500行 |
| **记忆文件** | 4个JSON | 28.5KB |
| **MCP服务器** | 3个配置 | ~20行 |
| **用户技能** | 8个技能 | ~100行 |
| **总计** | - | ~1000行 |

---

## ⚡ 启动时间

- **冷启动**: ~3-5秒 (首次加载)
- **热启动**: ~1-2秒 (缓存生效)
- **快速模式**: ~0.5秒 (最小化加载)

---

**总结**: 我通过 **CLAUDE.md → Skills/ → 记忆系统 → MCP配置 → 用户技能** 的顺序加载，构建完整的上下文，然后准备为您服务！

---

*由 GLM-4.7 (Claude Code) 自动生成*
*2026-01-16*
